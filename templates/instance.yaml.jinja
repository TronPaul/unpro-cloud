type: AWS::EC2::Instance
{% if depends_on %}
dependsOn: {{depends_on}}
{% endif %}
properties:
  InstanceType:
    Ref: {{instance_type}}
  KeyName:
    Ref: KeyName
{% if instance_profile %}
  IamInstanceProfile:
    Ref: {{instance_profile}}
{% endif %}
  NetworkInterfaces:
{% for ni in network_interfaces %}
    - NetworkInterfaceId:
        Ref: {{ni}}
      DeviceIndex: {{loop.index0}}
{% endfor %}
  ImageId:
    Fn::FindInMap:
      - {{image_map}}
      - Ref: AWS::Region
      - AMI
  Tags:
    - Key: Name
      Value: {{name}}
{% if roles %}
    - Key: Roles
      Value: {{roles|join(',')}}
{% endif %}
{% if tags %}
{% for k, v in tags.items() %}
    - Key: {{k}}
      Value: {{v}}
{% endfor %}
{% endif %}
  UserData:
    Fn::Base64:
      Fn::Join:
        - ""
        -
          - '#cloud-config\n'
          - 'repo_update: true\n'
          - 'runcmd:\n'
{% if has_salt %}
          - ' - /usr/local/bin/salt-up\n'
{% else %}
          - ' - wget -O bootstrap-unpro.sh https://raw.githubusercontent.com/TronPaul/unpro-salt/master/bootstrap-unpro-salt\n'
          - ' - sh ./bootstrap-unpro.sh -i {{name}}\n'
{% endif %}
          - 'output: { all : ''| tee -a /var/log/cloud-init-output.log'' }\n'
